services:

  gateway:
    volumes:
      - ./gateway:/app

  frontend:
    image: frontend:local-dev
    build:
      context: ../frontend
      target: builder # Target the Node stage, not the final Nginx stage
    volumes:
      - ../frontend:/app
      - /app/node_modules # Prevent host node_modules from overwriting container's
    ports:
      - "8080:80"
    # Install deps on start and run Vite with host binding (0.0.0.0)
    command: sh -c "npm install && npm run dev -- --host 0.0.0.0 --port 80"

  user:
    image: user:local-dev
    build:
      context: ../user-service
    ports:
      - "3001:3000"
    volumes:
      - ../user-service:/app
      - /app/node_modules
    # Use 'sh -c' to install dev dependencies (like ts-node-dev) before starting
    command: sh -c "npm install && npm run start:dev"

  threshold:
    image: threshold:local-dev
    build:
      context: ../threshold-service
    ports:
      - "3002:3000"
    volumes:
      - ../threshold-service:/app
      - /app/node_modules
    command: sh -c "npm install && npm run start:dev"

  forecast:
    image: forecast:local-dev
    build:
      context: ../forecast-service
      target: build # Target the JDK stage to allow compilation
    ports:
      - "3003:3000"
    volumes:
      - ../forecast-service:/usr/src/app
      - gradle-cache:/home/gradle/.gradle
    # Run with --continuous to enable Ktor Hot Reload
    command: ./gradlew run --continuous

  alert:
    image: alert:local-dev
    build:
      context: ../alert-service
    ports:
      - "3004:3000"
    volumes:
      - ../alert-service:/app
      - /app/node_modules
    command: sh -c "npm install && npm run start:dev"

  monitoring:
    image: monitoring:local-dev
    build:
      context: ../monitoring-service
    ports:
      - "3005:3000"
    volumes:
      - ../monitoring-service:/app
      - /app/node_modules
    command: sh -c "npm install && npm run start:dev"

  map:
    image: map:local-dev
    build:
      context: ../map-service
    ports:
      - "3006:3000"
    volumes:
      - ../map-service:/app
      - /app/node_modules
    command: sh -c "npm install && npm run start:dev"

  hookup:
    image: hookup:local-dev
    build:
      context: ../smart-furniture-hookup-service
    ports:
      - "3007:3000"
    volumes:
      - ../map-service:/app
      - /app/node_modules
    command: sh -c "npm install && npm run start:dev"

  influxdb:
    ports:
      - "8086:8086"

  mongodb:
    ports:
      - "27017:27017"

networks:
  internal:
    driver: bridge
    internal: false # Enable Internet access for package downloads (npm/gradle)

volumes:
  gradle-cache: